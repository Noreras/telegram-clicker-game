<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–∞–¥–æ–∫: –î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç</title>
    <style>
        body {
            margin: 0;
            background: #0f172a;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
        }
        #pause-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            z-index: 100;
        }
        #pause-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        #popup {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #020617;
            padding: 16px;
            border-radius: 12px;
            display: none;
            width: 300px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            z-index: 200;
            border: 1px solid #333;
        }
        #docInfo {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .btn {
            padding: 10px;
            margin-top: 6px;
            width: 100%;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            color: white;
        }
        .sign { background: #16a34a; }
        .sign:hover { background: #15803d; }
        .reject { background: #dc2626; }
        .reject:hover { background: #b91c1c; }
        .waiting { background: #f59e0b; }
        .waiting:hover { background: #d97706; }
        #resume-btn {
            background: #1d4ed8;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }
        #pause-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(2, 6, 23, 0.98);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            color: white;
            font-weight: bold;
            z-index: 300;
            display: none;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1d4ed8;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        }
        #stats-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(2, 6, 23, 0.98);
            padding: 30px;
            border-radius: 12px;
            color: white;
            text-align: center;
            z-index: 400;
            display: none;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            border: 1px solid #1e40af;
        }
        .stat-item {
            font-size: 16px;
            margin: 8px 0;
        }
        .highlight { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>
    <div id="panel">
        –û—á–∫–∏: <span id="score">0</span><br>
        –û—à–∏–±–∫–∏: <span id="mistakes">0</span>
    </div>

    <button id="pause-btn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>

    <div id="popup">
        <div id="docInfo"></div>
        <button class="btn sign">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
        <button class="btn reject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        <button class="btn waiting">–ù–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    </div>

    <div id="pause-modal">
        –ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ
        <button id="resume-btn">‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="stats-panel">
        <h3>üìä –ò—Ç–æ–≥–∏ –¥–Ω—è</h3>
        <div class="stat-item">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <span class="highlight" id="total-processed">0</span></div>
        <div class="stat-item">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: <span class="highlight" id="avg-time">0</span> —Å–µ–∫</div>
        <div class="stat-item">–û—à–∏–±–æ–∫: <span class="highlight" id="total-errors">0</span></div>
        <div class="stat-item">–ü–æ—Ç–µ—Ä—è–Ω–æ: <span class="highlight" id="lost-docs">0</span></div>
        <button class="btn" onclick="resetGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>

    <canvas id="game"></canvas>

    <script>
        /// <reference lib="dom" />

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const popup = document.getElementById("popup");
        const info = document.getElementById("docInfo");
        const pauseBtn = document.getElementById("pause-btn");
        const pauseModal = document.getElementById("pause-modal");
        const resumeBtn = document.getElementById("resume-btn");
        const statsPanel = document.getElementById("stats-panel");

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
        const docTexture = new Image();
        docTexture.src = 'https://raw.githubusercontent.com/Noreras/telegram-clicker-game/main/assets/textures/doc.png';

        resize();
        window.addEventListener("resize", resize);

        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let docs = [];
        let score = 0;
        let mistakes = 0;
        let selectedDoc = null;
        let isPaused = false;

        const MAX_DOCS = 5;
        let lastDocTime = 0;
        const DOC_INTERVAL = 1800;

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const stats = {
            totalProcessed: 0,
            errors: 0,
            processingTimes: [],
            lostDocs: 0,
            signedDocs: 0,
            rejectedDocs: 0
        };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function randomDoc() {
            const types = ["–£–ü–î", "–°–§", "–ê–∫—Ç", "–°—á—ë—Ç"];
            const type = types[Math.floor(Math.random() * types.length)];

            const contractors = [
                { name: "–û–û–û –†–æ–º–∞—à–∫–∞", errorRate: 0.5, urgent: false, burst: false },
                { name: "–ò–ü –ò–≤–∞–Ω–æ–≤", errorRate: 0.3, urgent: true, burst: false },
                { name: "–ê–û –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è", errorRate: 0.4, urgent: false, burst: true },
                { name: "–ù–æ–≤—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä", errorRate: 0.7, urgent: false, burst: false }
            ];
            const contractor = contractors[Math.floor(Math.random() * contractors.length)];

            return {
                x: Math.random() * (canvas.width - 60) + 30,
                y: -40,
                size: 30,
                speed: 0.8 + Math.random() * 0.6,
                type: type,
                contractor: contractor,
                valid: Math.random() > contractor.errorRate,
                status: "incoming",
                ttl: contractor.urgent ? 16000 : 24000,  // –£–≤–µ–ª–∏—á–µ–Ω–æ –≤ 2 —Ä–∞–∑–∞
                startTime: Date.now(),
                waitingReturn: false
            };
        }

        function update(currentTime) {
            if (isPaused) {
                requestAnimationFrame(update);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            if (currentTime - lastDocTime > DOC_INTERVAL && docs.length < MAX_DOCS) {
                docs.push(randomDoc());
                lastDocTime = currentTime;
            } else if (docs.length >= MAX_DOCS && currentTime - lastDocTime > DOC_INTERVAL) {
                stats.lostDocs++;
                mistakes += 2;
                showNotification("‚ùå –î–æ–∫—É–º–µ–Ω—Ç –ø–æ—Ç–µ—Ä—è–Ω ‚Äî –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞!");
                lastDocTime = currentTime;
            }

            for (let d of docs) {
                if (d.status === "incoming") {
                    d.y += d.speed;
                } else if (d.status === "signed") {
                    d.y -= 2;
                } else if (d.status === "rejected") {
                    d.y += 4;
                }

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –Ω–∏–∑—É
                if (d.y > canvas.height - 50 && d.status === "incoming") {
                    d.y = canvas.height - 50;
                }

                ctx.save();

                // –¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏
                let strokeColor;
                switch (d.status) {
                    case "incoming": strokeColor = "#3b82f6"; break;
                    case "signed":   strokeColor = "#10b981"; break;
                    case "rejected": strokeColor = "#ef4444"; break;
                    case "waiting":  strokeColor = "#f59e0b"; break;
                    default:         strokeColor = "#6b7280";
                }
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 3;

                // –¢–∞–π–º–µ—Ä-–∫–æ–ª—å—Ü–æ
                const elapsed = Date.now() - d.startTime;
                const progress = Math.min(elapsed / d.ttl, 1);
                ctx.beginPath();
                ctx.arc(d.x, d.y, d.size + 5, -Math.PI / 2, Math.PI * 2 * (1 - progress) - Math.PI / 2);
                ctx.stroke();

                // –ü–†–û–°–†–û–ß–ö–ê ‚Üí –£–î–ê–õ–ï–ù–ò–ï
                if (elapsed > d.ttl && d.status === "incoming") {
                    d.status = "overdue";
                    mistakes += 2;
                    showNotification("‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –∏ —É–¥–∞–ª—ë–Ω!");
                    docs = docs.filter(doc => doc !== d);
                    ctx.restore();
                    continue;
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä—ã
                ctx.beginPath();
                ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
                ctx.clip();

                if (docTexture.complete) {
                    ctx.drawImage(docTexture, d.x - d.size, d.y - d.size, d.size * 2, d.size * 2);
                } else {
                    ctx.fillStyle = d.valid ? "#22c55e" : "#ef4444";
                    ctx.fill();
                }

                ctx.restore();
                ctx.save();
                ctx.beginPath();
                ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
                ctx.stroke();

                // –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
                const typeColors = { "–£–ü–î": "#fbbf24", "–°–§": "#3b82f6", "–ê–∫—Ç": "#10b981", "–°—á—ë—Ç": "#f97316" };
                ctx.fillStyle = typeColors[d.type] || "white";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(d.type, d.x, d.y + 4);

                // –ò–∫–æ–Ω–∫–∏
                if (d.contractor.urgent) {
                    ctx.fillStyle = "#f59e0b";
                    ctx.font = "bold 14px Arial";
                    ctx.fillText("‚è±", d.x + d.size - 8, d.y - d.size + 5);
                }
                if (d.contractor.name === "–ù–æ–≤—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä") {
                    ctx.fillStyle = "#ef4444";
                    ctx.fillText("‚ùó", d.x + d.size - 8, d.y - d.size + 20);
                }
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å—É
            docs = docs.filter(d => {
                if (d.y < -50 && d.status === "signed") return false;
                if (d.y > canvas.height + 50 && d.status === "rejected") return false;
                return true;
            });

            document.getElementById("score").textContent = score;
            document.getElementById("mistakes").textContent = mistakes;
            requestAnimationFrame(update);
        }

        function openDoc(doc) {
            selectedDoc = doc;
            popup.style.display = "block";
            const timeLeft = Math.max(0, Math.floor((doc.ttl - (Date.now() - doc.startTime)) / 1000));
            info.innerHTML = `
                <b>${doc.type}</b><br>
                –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: ${doc.contractor.name}<br>
                –°—Ç–∞—Ç—É—Å: ${getStatusText(doc.status)}<br>
                <small>–û—Å—Ç–∞–ª–æ—Å—å: ${timeLeft} —Å–µ–∫</small>
            `;
        }

        function getStatusText(status) {
            return {
                incoming: "–í—Ö–æ–¥—è—â–∏–π",
                signed: "–ü–æ–¥–ø–∏—Å–∞–Ω",
                rejected: "–û—Ç–∫–ª–æ–Ω—ë–Ω",
                waiting: "–ù–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏",
                overdue: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω"
            }[status] || status;
        }

        document.querySelector(".sign").onclick = () => {
            if (!selectedDoc || isPaused) return;

            const isInvoice = selectedDoc.type === "–°—á—ë—Ç";
            if (isInvoice) {
                showNotification("üö´ –°—á—ë—Ç –Ω–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å!");
                mistakes += 3;
                stats.errors++;
                return;
            }

            if (selectedDoc.valid) {
                score += 10;
                selectedDoc.status = "signed";
            } else {
                score -= 15;
                selectedDoc.status = "rejected";
                mistakes += 2;
                stats.errors++;
            }
            finalizeDoc();
        };

        document.querySelector(".reject").onclick = () => {
            if (!selectedDoc || isPaused) return;
            score += 5;
            selectedDoc.status = "rejected";
            finalizeDoc();
        };

        document.querySelector(".waiting").onclick = () => {
            if (!selectedDoc || isPaused) return;
            selectedDoc.status = "waiting";
            selectedDoc.y = canvas.height - 100;
            showNotification("üìù –ù–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏");
            setTimeout(() => {
                selectedDoc.status = "incoming";
                selectedDoc.startTime = Date.now();
                selectedDoc.valid = Math.random() > 0.3;
            }, 3000);
            finalizeDoc();
        };

        function finalizeDoc() {
            const time = Date.now() - selectedDoc.startTime;
            stats.processingTimes.push(time);
            stats.totalProcessed++;
            if (selectedDoc.status === "signed") stats.signedDocs++;
            if (selectedDoc.status === "rejected") stats.rejectedDocs++;
            closeDoc();
        }

        function closeDoc() {
            docs = docs.filter(d => d !== selectedDoc);
            selectedDoc = null;
            popup.style.display = "none";
        }

        window.addEventListener("click", (e) => {
            if (e.target === popup) closeDoc();
        });

        canvas.addEventListener("click", e => {
            if (isPaused) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            for (let d of docs) {
                const dist = Math.hypot(x - d.x, y - d.y);
                if (dist < d.size && d.status === "incoming") {
                    openDoc(d);
                    break;
                }
            }
        });

        pauseBtn.addEventListener("click", () => {
            isPaused = true;
            pauseModal.style.display = "block";
        });

        resumeBtn.addEventListener("click", () => {
            isPaused = false;
            pauseModal.style.display = "none";
        });

        function showNotification(text) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = text;
            document.body.appendChild(n);
            setTimeout(() => {
                n.style.opacity = '0';
                setTimeout(() => n.remove(), 300);
            }, 2000);
        }

        function endGame() {
            const avg = stats.processingTimes.length > 0
                ? (stats.processingTimes.reduce((a,b) => a+b) / stats.processingTimes.length / 1000).toFixed(1)
                : "0";

            document.getElementById("total-processed").textContent = stats.totalProcessed;
            document.getElementById("avg-time").textContent = avg;
            document.getElementById("total-errors").textContent = stats.errors;
            document.getElementById("lost-docs").textContent = stats.lostDocs;

            statsPanel.style.display = "block";
        }

        function resetGame() {
            statsPanel.style.display = "none";
            docs = [];
            score = 0;
            mistakes = 0;
            stats.totalProcessed = 0;
            stats.errors = 0;
            stats.processingTimes = [];
            stats.lostDocs = 0;
            stats.signedDocs = 0;
            stats.rejectedDocs = 0;
            lastDocTime = 0;
            showNotification("üéÆ –ù–æ–≤—ã–π –¥–µ–Ω—å –Ω–∞—á–∞—Ç!");
        }

        requestAnimationFrame(update);

        setTimeout(() => {
            if (confirm("üéØ –•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä –î–∏–∞–¥–æ–∫–∞?")) {
                showNotification("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Å!");
            }
        }, 500);
    </script>
</body>
</html>
