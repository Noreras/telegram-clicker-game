<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ—Ñ–µ–π–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        
        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #0f3460;
        }
        
        #game-ui {
            position: fixed;
            top: max(env(safe-area-inset-top, 0px), 10px);
            left: 0;
            right: 0;
            padding: 12px 16px;
            background: linear-gradient(to bottom, rgba(26, 26, 46, 0.95), rgba(26, 26, 46, 0.8));
            color: white;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00adb5;
        }
        
        .ui-item {
            text-align: center;
        }
        
        .ui-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
            color: #a0a0c0;
        }
        
        .ui-value {
            font-size: 16px;
            font-weight: 700;
            color: #00adb5;
        }
        
        #location-indicator {
            position: fixed;
            top: max(env(safe-area-inset-top, 0px), 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 173, 181, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            z-index: 99;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-top: 70px;
        }
        
        .notification {
            position: fixed;
            top: max(env(safe-area-inset-top, 0px), 10px);
            right: 16px;
            background: #00adb5;
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            max-width: 80%;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            margin-top: 120px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        #day-end-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .panel-content {
            background: #16213e;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 3px solid #00adb5;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }
        
        .panel-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #00adb5;
            font-weight: 700;
        }
        
        .panel-stat {
            font-size: 17px;
            margin: 12px 0;
            color: #e0e0ff;
        }
        
        .panel-highlight {
            color: #00ff9d;
            font-weight: 700;
        }
        
        .panel-button {
            background: linear-gradient(135deg, #00adb5, #0097a7);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .panel-button:active {
            transform: scale(0.98);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        #instructions {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom, 0px), 20px);
            left: 16px;
            right: 16px;
            background: rgba(26, 26, 46, 0.9);
            color: #a0a0c0;
            padding: 15px;
            border-radius: 15px;
            font-size: 13px;
            line-height: 1.4;
            text-align: center;
            z-index: 99;
            border: 1px solid #2d4059;
        }
        
        #progress-bar {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom, 0px), 100px);
            left: 16px;
            right: 16px;
            height: 8px;
            background: rgba(45, 64, 89, 0.5);
            border-radius: 4px;
            overflow: hidden;
            z-index: 99;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00adb5, #00ff9d);
            width: 0%;
            transition: width 0.3s;
        }
        
        @media (max-width: 480px) {
            #game-ui {
                padding: 10px 12px;
                gap: 6px;
            }
            
            .ui-label {
                font-size: 10px;
            }
            
            .ui-value {
                font-size: 14px;
            }
            
            #location-indicator {
                font-size: 12px;
                padding: 6px 16px;
                margin-top: 60px;
            }
            
            .notification {
                font-size: 13px;
                margin-top: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-ui">
            <div class="ui-item">
                <div class="ui-label">–ë–ê–õ–ê–ù–°</div>
                <div class="ui-value" id="money">$100</div>
            </div>
            <div class="ui-item">
                <div class="ui-label">–î–ï–ù–¨</div>
                <div class="ui-value" id="day">1</div>
            </div>
            <div class="ui-item">
                <div class="ui-label">–ö–õ–ò–ï–ù–¢–´</div>
                <div class="ui-value" id="customers">0/5</div>
            </div>
            <div class="ui-item">
                <div class="ui-label">–í–†–ï–ú–Ø</div>
                <div class="ui-value" id="day-time">3:00</div>
            </div>
        </div>
        
        <div id="location-indicator">–ë–ê–†–ù–ê–Ø –ó–û–ù–ê</div>
        
        <canvas id="game-canvas"></canvas>
        
        <div id="progress-bar">
            <div id="progress-fill"></div>
        </div>
        
        <div id="instructions">
            üëÜ –¢–∞–ø–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚Ä¢ üéØ –¢–∞–ø–Ω–∏—Ç–µ –Ω–∞ –æ–±—ä–µ–∫—Ç –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è
        </div>
        
        <div id="day-end-panel">
            <div class="panel-content">
                <div class="panel-title">üéâ –°–ú–ï–ù–ê –ó–ê–í–ï–†–®–ï–ù–ê!</div>
                <div class="panel-stat">–û–±—Å–ª—É–∂–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: <span class="panel-highlight" id="served-count">0</span></div>
                <div class="panel-stat">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å: <span class="panel-highlight" id="earned-money">$0</span></div>
                <div class="panel-stat">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å: <span class="panel-highlight" id="total-money">$100</span></div>
                <button class="panel-button" onclick="startNewDay()">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–µ–Ω—å</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = {
            location: 'bar',
            money: 100,
            day: 1,
            customersToday: 0,
            customersServed: 0,
            dayTime: 180, // 3 –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            dayActive: true,
            earnedThisDay: 0,
            
            inventory: {
                coffee: 10,
                tea: 10,
                milk: 0,
                syrup: 0
            },
            
            prices: {
                coffee: 50,
                tea: 40
            },
            
            costs: {
                coffee: 20,
                tea: 15,
                milk: 30,
                syrup: 25
            },
            
            storageCapacity: {
                coffee: 20,
                tea: 20,
                milk: 10,
                syrup: 10
            },
            
            currentCustomer: null,
            currentOrder: null,
            isPreparing: false,
            preparationProgress: 0,
            preparationTotal: 0,
            
            player: {
                x: 0,
                y: 0,
                size: 20,
                color: '#000000',
                targetX: null,
                targetY: null,
                speed: 4,
                isMoving: false,
                interactionTarget: null
            },
            
            customers: [],
            nextCustomerTime: 0,
            
            objects: {
                bar: [],
                storage: []
            },
            
            // –î–ª—è —Ç–∞–π–º–µ—Ä–∞ –¥–Ω—è
            lastTimeUpdate: Date.now()
        };
        
        // ==================== –†–ê–ó–ú–ï–†–´ –ò –û–ë–™–ï–ö–¢–´ ====================
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initObjects();
        }
        
        function initObjects() {
            const width = canvas.width;
            const height = canvas.height;
            const objSize = Math.min(width, height) * 0.05;
            
            gameState.player.size = Math.min(width, height) * 0.04;
            
            // –ë–∞—Ä–Ω–∞—è –∑–æ–Ω–∞
            gameState.objects.bar = [
                { 
                    id: 'cashier', type: 'cashier', 
                    x: width * 0.15, y: height * 0.2, 
                    width: objSize * 2, height: objSize * 1.5, 
                    color: '#3498db', label: '–ö–∞—Å—Å–∞',
                    collision: true
                },
                { 
                    id: 'coffee_machine', type: 'machine', 
                    x: width * 0.3, y: height * 0.2, 
                    width: objSize * 1.5, height: objSize * 1.5, 
                    color: '#e74c3c', label: '–ö–æ—Ñ–µ',
                    collision: true
                },
                { 
                    id: 'tea_maker', type: 'machine', 
                    x: width * 0.45, y: height * 0.2, 
                    width: objSize * 1.5, height: objSize * 1.5, 
                    color: '#2ecc71', label: '–ß–∞–π',
                    collision: true
                },
                { 
                    id: 'table1', type: 'table', 
                    x: width * 0.25, y: height * 0.7, 
                    width: objSize * 3, height: objSize * 1.5, 
                    color: '#9b59b6', label: '–°—Ç–æ–ª 1',
                    collision: true
                },
                { 
                    id: 'table2', type: 'table', 
                    x: width * 0.5, y: height * 0.7, 
                    width: objSize * 3, height: objSize * 1.5, 
                    color: '#9b59b6', label: '–°—Ç–æ–ª 2',
                    collision: true
                },
                { 
                    id: 'door', type: 'door', 
                    x: width * 0.9, y: height * 0.5, 
                    width: objSize * 0.8, height: objSize * 3, 
                    color: '#f39c12', label: '‚Üí –°–∫–ª–∞–¥',
                    collision: false
                }
            ];
            
            // –°–∫–ª–∞–¥
            gameState.objects.storage = [
                { 
                    id: 'coffee_shelf', type: 'shelf', 
                    x: width * 0.2, y: height * 0.3, 
                    width: objSize * 3, height: objSize * 2, 
                    color: '#795548', label: '–ö–æ—Ñ–µ',
                    collision: true
                },
                { 
                    id: 'tea_shelf', type: 'shelf', 
                    x: width * 0.4, y: height * 0.3, 
                    width: objSize * 3, height: objSize * 2, 
                    color: '#4CAF50', label: '–ß–∞–π',
                    collision: true
                },
                { 
                    id: 'milk_shelf', type: 'shelf', 
                    x: width * 0.6, y: height * 0.3, 
                    width: objSize * 3, height: objSize * 2, 
                    color: '#FFEBEE', label: '–ú–æ–ª–æ–∫–æ',
                    collision: true
                },
                { 
                    id: 'syrup_shelf', type: 'shelf', 
                    x: width * 0.8, y: height * 0.3, 
                    width: objSize * 3, height: objSize * 2, 
                    color: '#FF9800', label: '–°–∏—Ä–æ–ø',
                    collision: true
                },
                { 
                    id: 'order_board', type: 'board', 
                    x: width * 0.4, y: height * 0.6, 
                    width: objSize * 4, height: objSize * 2, 
                    color: '#607D8B', label: '–ó–∞–∫–∞–∑–∞—Ç—å',
                    collision: true
                },
                { 
                    id: 'end_day', type: 'button', 
                    x: width * 0.4, y: height * 0.8, 
                    width: objSize * 5, height: objSize * 2, 
                    color: '#e74c3c', label: '–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É',
                    collision: true
                },
                { 
                    id: 'door_back', type: 'door', 
                    x: width * 0.1, y: height * 0.5, 
                    width: objSize * 0.8, height: objSize * 3, 
                    color: '#f39c12', label: '‚Üê –ë–∞—Ä',
                    collision: false
                }
            ];
            
            // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
            updatePlayerPosition();
        }
        
        function updatePlayerPosition() {
            const width = canvas.width;
            const height = canvas.height;
            
            if (gameState.location === 'bar') {
                gameState.player.x = width * 0.1;
                gameState.player.y = height * 0.5;
            } else {
                gameState.player.x = width * 0.9;
                gameState.player.y = height * 0.5;
            }
            
            gameState.player.targetX = null;
            gameState.player.targetY = null;
            gameState.player.interactionTarget = null;
        }
        
        // ==================== –ö–û–õ–õ–ò–ó–ò–ò ====================
        function checkCollision(x, y, object) {
            const left = object.x - object.width / 2;
            const right = object.x + object.width / 2;
            const top = object.y - object.height / 2;
            const bottom = object.y + object.height / 2;
            
            return x >= left && x <= right && y >= top && y <= bottom;
        }
        
        function isValidPosition(x, y) {
            const objects = gameState.objects[gameState.location];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏
            for (const obj of objects) {
                if (obj.collision) {
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–æ–Ω—É –∫–æ–ª–ª–∏–∑–∏–∏ –¥–ª—è –ª—É—á—à–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                    const margin = gameState.player.size * 1.5;
                    const left = obj.x - obj.width / 2 - margin;
                    const right = obj.x + obj.width / 2 + margin;
                    const top = obj.y - obj.height / 2 - margin;
                    const bottom = obj.y + obj.height / 2 + margin;
                    
                    if (x >= left && x <= right && y >= top && y <= bottom) {
                        return false;
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const margin = gameState.player.size;
            return x >= margin && 
                   x <= canvas.width - margin && 
                   y >= margin && 
                   y <= canvas.height - margin;
        }
        
        // ==================== –£–¢–ò–õ–ò–¢–´ ====================
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 2500);
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.showAlert(text);
            }
        }
        
        function updateUI() {
            document.getElementById('money').textContent = `$${gameState.money}`;
            document.getElementById('day').textContent = gameState.day;
            document.getElementById('customers').textContent = `${gameState.customersServed}/${gameState.customersToday}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
            const now = Date.now();
            if (now - gameState.lastTimeUpdate > 1000) {
                if (gameState.dayTime > 0) {
                    gameState.dayTime--;
                }
                gameState.lastTimeUpdate = now;
            }
            
            const minutes = Math.floor(gameState.dayTime / 60);
            const seconds = gameState.dayTime % 60;
            document.getElementById('day-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–æ–∫–∞—Ü–∏–∏
            document.getElementById('location-indicator').textContent = 
                gameState.location === 'bar' ? '–ë–ê–†–ù–ê–Ø –ó–û–ù–ê' : '–°–ö–õ–ê–î';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progress = (gameState.customersServed / Math.max(gameState.customersToday, 1)) * 100;
            document.getElementById('progress-fill').style.width = `${Math.min(progress, 100)}%`;
        }
        
        // ==================== –ö–õ–ò–ï–ù–¢–´ ====================
        function spawnCustomer() {
            if (gameState.customersToday >= 5 || !gameState.dayActive) return;
            
            const table = gameState.customers.length === 0 ? 'table1' : 'table2';
            const customer = {
                id: Date.now(),
                table: table,
                x: canvas.width + 50,
                y: canvas.height * 0.2,
                size: Math.min(canvas.width, canvas.height) * 0.03,
                color: '#FFFFFF',
                state: 'walking',
                order: null,
                patience: 100,
                patienceTimer: 0
            };
            
            const orders = ['coffee', 'tea'];
            customer.order = orders[Math.floor(Math.random() * orders.length)];
            
            gameState.customers.push(customer);
            gameState.customersToday++;
            gameState.nextCustomerTime = Date.now() + 15000;
            
            showNotification('üÜï –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç!');
            updateUI();
        }
        
        function updateCustomers() {
            for (let i = gameState.customers.length - 1; i >= 0; i--) {
                const customer = gameState.customers[i];
                
                if (customer.state === 'walking') {
                    const table = gameState.objects.bar.find(obj => obj.id === customer.table);
                    const targetX = table.x;
                    const targetY = table.y - table.height/2 - customer.size;
                    
                    const dx = targetX - customer.x;
                    const dy = targetY - customer.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 5) {
                        customer.state = 'waiting';
                        customer.color = '#FFFF00';
                    } else {
                        customer.x += (dx / distance) * 3;
                        customer.y += (dy / distance) * 3;
                    }
                }
                else if (customer.state === 'eating') {
                    customer.patienceTimer++;
                    if (customer.patienceTimer > 180) {
                        customer.state = 'leaving';
                        customer.color = '#FFFFFF';
                    }
                }
                else if (customer.state === 'leaving') {
                    customer.x += 3;
                    if (customer.x > canvas.width + 100) {
                        gameState.customers.splice(i, 1);
                    }
                }
                else if (customer.state === 'waiting') {
                    customer.patienceTimer++;
                    if (customer.patienceTimer > 300) {
                        customer.state = 'leaving';
                        customer.color = '#FFFFFF';
                        showNotification('üò† –ö–ª–∏–µ–Ω—Ç —É—à–µ–ª –Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã–π');
                    }
                }
            }
        }
        
        function serveCustomer(tableId, drinkType) {
            const customer = gameState.customers.find(c => c.table === tableId && c.state === 'waiting');
            if (!customer) return false;
            
            if (customer.order === drinkType && gameState.inventory[drinkType] > 0) {
                customer.state = 'eating';
                customer.color = '#00FF00';
                customer.patienceTimer = 0;
                
                const earned = gameState.prices[drinkType];
                gameState.money += earned;
                gameState.earnedThisDay += earned;
                gameState.customersServed++;
                gameState.inventory[drinkType]--;
                
                showNotification(`‚úÖ –û–±—Å–ª—É–∂–µ–Ω –∫–ª–∏–µ–Ω—Ç! +$${earned}`);
                updateUI();
                return true;
            }
            return false;
        }
        
        // ==================== –ü–ï–†–°–û–ù–ê–ñ ====================
        function updatePlayer() {
            const player = gameState.player;
            
            if (player.targetX !== null && player.targetY !== null) {
                const dx = player.targetX - player.x;
                const dy = player.targetY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.speed) {
                    player.x = player.targetX;
                    player.y = player.targetY;
                    player.targetX = null;
                    player.targetY = null;
                    player.isMoving = false;
                    player.color = '#000000';
                    
                    if (player.interactionTarget) {
                        setTimeout(() => interactWithObject(player.interactionTarget), 100);
                        player.interactionTarget = null;
                    }
                } else {
                    const nextX = player.x + (dx / distance) * player.speed;
                    const nextY = player.y + (dy / distance) * player.speed;
                    
                    if (isValidPosition(nextX, nextY)) {
                        player.x = nextX;
                        player.y = nextY;
                        player.isMoving = true;
                        player.color = '#808080';
                    } else {
                        // –ü–æ–∏—Å–∫ –æ–±—Ö–æ–¥–Ω–æ–≥–æ –ø—É—Ç–∏
                        const angles = [0, Math.PI/4, -Math.PI/4, Math.PI/2, -Math.PI/2];
                        for (const angle of angles) {
                            const offsetX = Math.cos(angle) * player.speed * 2;
                            const offsetY = Math.sin(angle) * player.speed * 2;
                            
                            if (isValidPosition(player.x + offsetX, player.y + offsetY)) {
                                player.targetX = player.x + offsetX;
                                player.targetY = player.y + offsetY;
                                return;
                            }
                        }
                        
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø—É—Ç—å, –æ—Ç–º–µ–Ω—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
                        player.targetX = null;
                        player.targetY = null;
                        player.interactionTarget = null;
                        showNotification('üö´ –ü—É—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                    }
                }
            }
        }
        
        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç
            const objects = gameState.objects[gameState.location];
            let clickedObject = null;
            
            for (const obj of objects) {
                if (checkCollision(x, y, obj)) {
                    clickedObject = obj;
                    break;
                }
            }
            
            if (clickedObject) {
                // –î–≤–∏–≥–∞–µ–º—Å—è –∫ –æ–±—ä–µ–∫—Ç—É, –Ω–æ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                const safeDistance = clickedObject.type === 'door' ? 0 : gameState.player.size * 2;
                const angle = Math.atan2(clickedObject.y - gameState.player.y, clickedObject.x - gameState.player.x);
                const targetX = clickedObject.x - Math.cos(angle) * safeDistance;
                const targetY = clickedObject.y - Math.sin(angle) * safeDistance;
                
                if (isValidPosition(targetX, targetY)) {
                    gameState.player.targetX = targetX;
                    gameState.player.targetY = targetY;
                    gameState.player.interactionTarget = clickedObject;
                } else {
                    showNotification('–ù–µ –º–æ–≥—É –ø–æ–¥–æ–π—Ç–∏ –∫ –æ–±—ä–µ–∫—Ç—É!');
                }
            } else {
                // –ü—Ä–æ—Å—Ç–æ –¥–≤–∏–≥–∞–µ–º—Å—è –∫ —Ç–æ—á–∫–µ, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                if (isValidPosition(x, y)) {
                    gameState.player.targetX = x;
                    gameState.player.targetY = y;
                    gameState.player.interactionTarget = null;
                } else {
                    showNotification('–ù–µ –º–æ–≥—É –¥–æ–π—Ç–∏ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏!');
                }
            }
        });
        
        // ==================== –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø ====================
        function interactWithObject(object) {
            if (object.type === 'door') {
                // –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏
                gameState.location = gameState.location === 'bar' ? 'storage' : 'bar';
                updatePlayerPosition();
                showNotification(`–ü–µ—Ä–µ—à–ª–∏ –≤ ${gameState.location === 'bar' ? '–±–∞—Ä' : '—Å–∫–ª–∞–¥'}`);
            }
            else if (object.type === 'cashier' && gameState.currentCustomer) {
                gameState.currentOrder = gameState.currentCustomer.order;
                gameState.currentCustomer = null;
                showNotification(`–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç: ${gameState.currentOrder === 'coffee' ? '–ö–æ—Ñ–µ' : '–ß–∞–π'}`);
            }
            else if (object.type === 'machine' && gameState.currentOrder) {
                if (gameState.inventory[gameState.currentOrder] <= 0) {
                    showNotification('‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤!');
                    return;
                }
                
                gameState.isPreparing = true;
                gameState.preparationProgress = 0;
                gameState.preparationTotal = gameState.currentOrder === 'coffee' ? 180 : 120;
                gameState.player.color = '#FFFF00';
                showNotification(`–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ${gameState.currentOrder === 'coffee' ? '–∫–æ—Ñ–µ' : '—á–∞—è'}...`);
            }
            else if (object.type === 'table') {
                const drinkType = gameState.currentOrder;
                if (drinkType && serveCustomer(object.id, drinkType)) {
                    gameState.currentOrder = null;
                    gameState.isPreparing = false;
                    gameState.player.color = '#000000';
                }
            }
            else if (object.type === 'shelf') {
                const ingredient = object.id.replace('_shelf', '');
                const current = gameState.inventory[ingredient];
                const max = gameState.storageCapacity[ingredient];
                showNotification(`${object.label}: ${current}/${max}`);
            }
            else if (object.type === 'board') {
                orderIngredients();
            }
            else if (object.type === 'button' && object.id === 'end_day') {
                endDay();
            }
        }
        
        function orderIngredients() {
            let orderText = "";
            let totalCost = 0;
            let ordered = false;
            
            ['coffee', 'tea', 'milk', 'syrup'].forEach(ingredient => {
                const current = gameState.inventory[ingredient];
                const max = gameState.storageCapacity[ingredient];
                const need = max - current;
                
                if (need > 0) {
                    const cost = need * gameState.costs[ingredient];
                    
                    if (gameState.money >= totalCost + cost) {
                        totalCost += cost;
                        ordered = true;
                    }
                }
            });
            
            if (ordered) {
                // –ü–æ–∫—É–ø–∞–µ–º –≤—Å–µ —á—Ç–æ –º–æ–∂–µ–º
                ['coffee', 'tea', 'milk', 'syrup'].forEach(ingredient => {
                    const current = gameState.inventory[ingredient];
                    const max = gameState.storageCapacity[ingredient];
                    const need = max - current;
                    
                    if (need > 0) {
                        const cost = need * gameState.costs[ingredient];
                        if (gameState.money >= cost) {
                            gameState.inventory[ingredient] = max;
                            gameState.money -= cost;
                            orderText += `‚úÖ ${ingredient}: +${need} (-$${cost})\n`;
                        }
                    }
                });
                
                showNotification(orderText || "–ó–∞–∫–∞–∑–∞–Ω–æ!");
                updateUI();
            } else {
                showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –∏–ª–∏ –≤—Å–µ –∑–∞–ø–∞—Å—ã –ø–æ–ª–Ω—ã–µ!");
            }
        }
        
        // ==================== –°–ò–°–¢–ï–ú–ê –î–ù–ï–ô ====================
        function endDay() {
            gameState.dayActive = false;
            document.getElementById('day-end-panel').style.display = 'flex';
            document.getElementById('served-count').textContent = gameState.customersServed;
            document.getElementById('earned-money').textContent = `$${gameState.earnedThisDay}`;
            document.getElementById('total-money').textContent = `$${gameState.money}`;
            
            showNotification(`üìä –î–µ–Ω—å ${gameState.day} –∑–∞–≤–µ—Ä—à–µ–Ω!`);
        }
        
        function startNewDay() {
            gameState.day++;
            gameState.customersToday = 0;
            gameState.customersServed = 0;
            gameState.dayTime = 180;
            gameState.dayActive = true;
            gameState.earnedThisDay = 0;
            gameState.customers = [];
            gameState.currentCustomer = null;
            gameState.currentOrder = null;
            gameState.isPreparing = false;
            gameState.nextCustomerTime = Date.now() + 5000;
            gameState.lastTimeUpdate = Date.now();
            
            document.getElementById('day-end-panel').style.display = 'none';
            showNotification(`üéÆ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–Ω—å ${gameState.day}!`);
            updateUI();
        }
        
        // ==================== –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ====================
        function updateGame() {
            if (!gameState.dayActive) return;
            
            // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
            if (Date.now() > gameState.nextCustomerTime && gameState.customersToday < 5) {
                spawnCustomer();
            }
            
            updateCustomers();
            updatePlayer();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
            if (gameState.isPreparing) {
                gameState.preparationProgress++;
                if (gameState.preparationProgress >= gameState.preparationTotal) {
                    gameState.isPreparing = false;
                    gameState.player.color = '#000000';
                    showNotification(`‚úÖ ${gameState.currentOrder === 'coffee' ? '–ö–æ—Ñ–µ' : '–ß–∞–π'} –≥–æ—Ç–æ–≤!`);
                }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã
            if (!gameState.currentCustomer) {
                const waitingCustomer = gameState.customers.find(c => c.state === 'waiting');
                if (waitingCustomer) {
                    gameState.currentCustomer = waitingCustomer;
                    showNotification(`–ö–ª–∏–µ–Ω—Ç –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç: ${waitingCustomer.order === 'coffee' ? '–ö–æ—Ñ–µ' : '–ß–∞–π'}`);
                }
            }
            
            updateUI();
        }
        
        // ==================== –û–¢–†–ò–°–û–í–ö–ê ====================
        function drawGame() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π –ª–æ–∫–∞—Ü–∏–∏
            const objects = gameState.objects[gameState.location];
            objects.forEach(obj => {
                // –û–±—ä–µ–∫—Ç
                ctx.fillStyle = obj.color;
                ctx.fillRect(
                    obj.x - obj.width/2, 
                    obj.y - obj.height/2, 
                    obj.width, 
                    obj.height
                );
                
                                    // –ö–æ–Ω—Ç—É—Ä
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            });
        }
        
        // –†–∏—Å—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        const player = gameState.player;
        ctx.fillStyle = player.color;
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
        ctx.fill();
        
        // –ö–æ–Ω—Ç—É—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞ –Ω–∞–¥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º
        if (gameState.currentOrder) {
            ctx.fillStyle = gameState.currentOrder === 'coffee' ? '#8B4513' : '#4CAF50';
            ctx.beginPath();
            ctx.arc(player.x, player.y - player.size * 2, player.size * 0.8, 0, Math.PI * 2);
            ctx.fill();
            
            // –ö–æ–Ω—Ç—É—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
        if (gameState.isPreparing) {
            const progress = gameState.preparationProgress / gameState.preparationTotal;
            const barWidth = canvas.width * 0.6;
            const barHeight = 20;
            const barX = (canvas.width - barWidth) / 2;
            const barY = canvas.height * 0.1;
            
            // –§–æ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            ctx.fillStyle = '#00adb5';
            ctx.fillRect(barX, barY, barWidth * progress, barHeight);
            
            // –ö–æ–Ω—Ç—É—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.strokeRect(barX, barY, barWidth, barHeight);
            
            // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const drinkName = gameState.currentOrder === 'coffee' ? '–∫–æ—Ñ–µ' : '—á–∞—è';
            ctx.fillText(
                `–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ ${drinkName}... ${Math.round(progress * 100)}%`,
                canvas.width / 2,
                barY + barHeight / 2
            );
        }
        
        // –†–∏—Å—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∫–ª–∞–¥–µ)
        if (gameState.location === 'storage') {
            const startX = 20;
            const startY = canvas.height * 0.15;
            const lineHeight = 20;
            
            // –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(startX - 10, startY - 10, 200, 100);
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ctx.fillStyle = '#00adb5';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('üì¶ –ó–ê–ü–ê–°–´:', startX, startY);
            
            // –°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
            ctx.font = '14px Arial';
            let y = startY + lineHeight;
            
            ['coffee', 'tea', 'milk', 'syrup'].forEach((ingredient, index) => {
                const current = gameState.inventory[ingredient];
                const max = gameState.storageCapacity[ingredient];
                const percent = (current / max) * 100;
                
                // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
                if (percent < 30) ctx.fillStyle = '#e74c3c';
                else if (percent < 70) ctx.fillStyle = '#f39c12';
                else ctx.fillStyle = '#2ecc71';
                
                const ingredientName = {
                    'coffee': '–ö–æ—Ñ–µ',
                    'tea': '–ß–∞–π', 
                    'milk': '–ú–æ–ª–æ–∫–æ',
                    'syrup': '–°–∏—Ä–æ–ø'
                }[ingredient];
                
                ctx.fillText(`${ingredientName}: ${current}/${max}`, startX, y + lineHeight * index);
            });
        }
        
        // –†–∏—Å—É–µ–º —Ü–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (gameState.player.targetX && gameState.player.targetY) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(gameState.player.targetX, gameState.player.targetY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#00ff9d';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(gameState.player.targetX, gameState.player.targetY, 12, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (gameState.player.targetX && gameState.player.targetY && gameState.player.isMoving) {
            ctx.strokeStyle = 'rgba(0, 173, 181, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(gameState.player.x, gameState.player.y);
            ctx.lineTo(gameState.player.targetX, gameState.player.targetY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }
    
    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ü–£–°–ö ====================
    function init() {
        resizeCanvas();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.setHeaderColor('#1a1a2e');
                Telegram.WebApp.setBackgroundColor('#1a1a2e');
                
                showNotification('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ù–∞—á–Ω–∏—Ç–µ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤.');
            } catch (e) {
                console.log('Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', e);
            }
        }
        
        // –ü–µ—Ä–≤—ã–π –∫–ª–∏–µ–Ω—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (gameState.dayActive) {
                gameState.nextCustomerTime = Date.now() + 5000;
            }
        }, 5000);
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updateGame();
            drawGame();
            requestAnimationFrame(gameLoop);
        }
        
        gameLoop();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            resizeCanvas();
            drawGame();
        });
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', init);
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ HTML
    window.startNewDay = startNewDay;
    
    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
    window.gameState = gameState;
    console.log('–ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ö–æ–º–∞–Ω–¥—ã:');
    console.log('- gameState - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã');
    console.log('- startNewDay() - –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–µ–Ω—å');
    console.log('- showNotification("—Ç–µ–∫—Å—Ç") - –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
</script>
